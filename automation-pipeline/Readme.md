## License
This project is licensed under the Apache License 2.0. You can find the full license text at: [https://www.apache.org/licenses/LICENSE-2.0](https://www.apache.org/licenses/LICENSE-2.0)
# **AWS Selenium CodePipeline**

The scope of this pattern is to provide a guide and ready to use terraform configurations to setup Selenium Automation pipeline with end-to-end tests based on AWS CodePipeline, AWS CodeBuild and Terraform.

## Infrastructure

### IAM Role for CodeBuild and CodePipeline

This IAM role grants necessary permissions for CodeBuild and CodePipeline to perform actions such as accessing S3 buckets, executing CodeBuild projects, and interacting with other AWS services.

### S3 Bucket

An S3 bucket is used to store artifacts generated during the build process and test reports generated by Selenium tests.

### CodeBuild for Running Selenium Tests

The CodeBuild project is configured to execute Selenium tests. It fetches the test code from the Git repository, installs necessary dependencies, and runs the tests.

### CodePipeline

The CodePipeline consists of two stages:

1. **Source Stage**: This stage collects the source code from the specified **Git repository** .

2. **Selenium Test Stage**: This stage triggers the CodeBuild project to run Selenium tests. It fetches the source code from the previous stage and initiates the test execution.

## Directory Structure
This project uses Terraform modules to manage infrastructure for running Selenium tests on AWS.

```             
├── main.tf
├── variables.tf
├── modules/
│   ├── iam-role/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── s3-bucket/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── codebuild-selenium/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   └── codepipeline/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf
├── terraform.tfvars
└── Readme.md
|__ buildspec.yml

```             

## Terraform Configuration

### `main.tf`

This file orchestrates the Terraform modules.

### `terraform.tfvars`

This file contains values for variables used in the Terraform configuration.

### Modules

Each module encapsulates the configuration for a specific resource:

## 1. Iam-role: ## 
This module creates IAM roles and policies necessary for AWS CodeBuild and CodePipeline to execute tasks and interact with other AWS services within your project.

## IAM Policies

### CodeBuild Policy

- Allows CodeBuild to perform actions such as starting builds, accessing S3 buckets for artifacts, interacting with CodePipeline, and accessing CloudWatch Logs.

### CodePipeline Policy

- Allows CodePipeline to pass roles, start pipeline executions, interact with S3 buckets, access Secrets Manager, and interact with CloudWatch Logs.

## Usage

To use this module, follow these steps:

1. Define necessary input variables for the module, such as project name and S3 bucket ARN.

2. Include the module in your main Terraform configuration, providing required input values.

3. Run Terraform commands (`terraform init`, `terraform plan`, `terraform apply`) to create IAM roles and policies.

4. Ensure that the created roles are assigned to respective services (CodeBuild and CodePipeline) and have necessary permissions.

## Module Structure

The IAM role module consists of the following files:

- `main.tf`: Defines IAM roles and policies for CodeBuild and CodePipeline.
- `variables.tf`: Declares input variables required for the module.
- `outputs.tf`: Defines output values if needed.

## Note
Make sure to replace placeholder values with actual values relevant to your project.
Review the IAM policies to ensure least privilege access.

2. ## s3-bucket: ## 
## Overview

This module creates an Amazon S3 bucket with specified configurations for your project. The S3 bucket is used for storing artifacts, reports, and any other files needed for your application.

## Bucket Configuration

The S3 bucket created by this module has the following configurations:

- **Bucket Name**: Specified by the `bucket_name` variable.
- **Access Control List (ACL)**: Set to "private" to restrict access to bucket contents.
- **Tags**: Tags specified by the `tags` variable are applied to the bucket.
- **Versioning**: Enabled to maintain multiple versions of objects in the bucket.
- **Lifecycle Policy**: Enabled to automatically expire objects after a specified number of days (`expiration_days` variable).

## Usage

To use this module, follow these steps:

1. Define necessary input variables for the module, such as bucket name, tags, and expiration days.

2. Include the module in your main Terraform configuration, providing required input values.

3. Run Terraform commands (`terraform init`, `terraform plan`, `terraform apply`) to create the S3 bucket.

4. Ensure that the created bucket is used appropriately within your project, such as storing artifacts or reports generated during CI/CD processes.

## Module Structure

The S3 bucket module consists of the following files:

- `main.tf`: Defines the AWS S3 bucket resource with specified configurations.
- `variables.tf`: Declares input variables required for the module.
- `outputs.tf`: Defines output values if needed.

## Note
- Make sure to replace placeholder values with actual values relevant to your project.
- Review the S3 bucket configuration to ensure it meets your project's requirements and security standards.

## 3. Codebuild: ##
## Overview
Configures CodeBuild project to run Selenium tests.

 a) Create a new directory codebuild within the modules directory of your accelerator.

 b) Inside the codebuild directory, create the following files:

    . main.tf: Define the CodeBuild project.

    . variables.tf: Declare input variables for the CodeBuild project.

Here's an example of how  module directory structure might look:
```         
├── modules/
│   ├── codebuild/
│   │   ├── main.tf
│   │   ├── variables.tf
```         
**Define CodeBuild Configuration**     
In modules/codebuild/main.tf, define your CodeBuild project using Terraform resources. You'll need to specify details such as source, build environment, and build commands.

**Input Variables**
In modules/codebuild/variables.tf, declare input variables for your CodeBuild project. These variables can include things like project name, source code repository, environment variables, etc. 

**Usage in Main Configuration**
In your main Terraform configuration (main.tf), utilize the CodeBuild module by calling it and passing necessary input variables.

## Note
Make sure to replace placeholder values with actual values relevant to your setup.
Ensure that the IAM role (aws_iam_role.codebuild_role in this case) used for CodeBuild has necessary permissions.
Adjust the configuration as per your specific requirements and project setup.

4. ** Codepipeline **: Configures CodePipeline with source and Selenium test stages.

## Usage

1. Define required variables in `terraform.tfvars`.
2. Edit Buildspec.yml as per your configurations. 
3. Run `terraform init` to initialize Terraform.
4. Run `terraform plan` to review the execution plan.
5. Run `terraform apply` to provision the infrastructure.

**Buildspec.yml**
## Overview

This repository contains a buildspec.yml file that can be used with AWS CodeBuild to execute Selenium tests. Selenium tests are automated tests that simulate user interactions with web applications.

## Build Specification

The provided `buildspec.yml` defines the following phases:

- **Install**: Installs necessary dependencies and tools required for running Selenium tests. It installs Java runtime and Google Chrome browser.

- **Pre Build**: Configures the display for running Chrome in headless mode using Xvfb.

- **Build**: Executes Selenium tests using Maven.

- **Post Build**: Uploads the generated test report to an S3 bucket and sends a notification to Slack about the test execution status.

## Usage

To use this `buildspec.yml` with AWS CodeBuild, follow these steps:

1. Create an AWS CodeBuild project in your AWS account.

2. Use the provided `buildspec.yml` as the build specification for the CodeBuild project.

3. Set up the necessary environment variables in the CodeBuild project, including:
   - `java_version`: The Java version to be used (e.g., "8", "11").
   - `chrome_download_url`: The URL to download the Chrome browser.
   - `S3_Bucket`: The name of the S3 bucket where the test report will be uploaded.
   -  `--secret-id`: This is the ID of the secret that you will create for storing WEBHOOK_URL



## Artifacts

The test artifacts, including the generated test report, are uploaded to the specified S3 bucket.

## Notifications

After the test execution, a notification is sent to a Slack channel indicating the status of the test execution. The notification includes a link to view the detailed test report.


## Notes

- Make sure to replace placeholder values in the Terraform configuration files with actual values specific to your environment.
- Review IAM permissions to ensure least privilege access.


